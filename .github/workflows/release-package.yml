name: Release a Package

on:
  push:
    tags:
      - "release/*/v*"
      - "release/*/v*-release"
      - "release/*/v*-beta"
      - "release/*/v*-alpha"
      - "release/*/v*-next"

jobs:
  extract_info:
    name: Extract Release Type and Version ğŸ“‹
    runs-on: ubuntu-latest

    outputs:
      release_type: ${{ steps.extract_info.outputs.release_type }}
      version: ${{ steps.extract_info.outputs.version }}
      release_tag: ${{ steps.extract_info.outputs.release_tag }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Extract Release Type and Version ğŸ“‹
        id: extract_info
        run: |
          TAG=${GITHUB_REF#refs/tags/release/}
          RELEASE_TYPE=${TAG%%/v*}
          VERSION=${TAG#*/v}

          if [[ $VERSION == *"alpha" ]]; then
            RELEASE_TAG="-alpha"
          elif [[ $VERSION == *"beta" ]]; then
            RELEASE_TAG="-beta"
          elif [[ $VERSION == *"next" ]]; then
            RELEASE_TAG="-next"
          else
            RELEASE_TAG="release"
          fi

          echo "release_type=${RELEASE_TYPE}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

      - name: Dump Release Info
        run: |
          echo "Release Type: ${{ steps.extract_info.outputs.release_type }} Version: ${{ steps.extract_info.outputs.version }} extracted from ${GITHUB_REF}, Release Tag: ${{ steps.extract_info.outputs.release_tag }}"

  build:
    name: Build ğŸ› ï¸
    runs-on: ubuntu-latest
    needs: extract_info
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3
      - name: Setup Node.js ğŸ“¦
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install dependencies ğŸ”ƒ
        run: |
          npm ci
          npm run gulp packages:${{needs.extract_info.outputs.release_type}}:ci

      - name: Build ğŸ”¨
        run: npm run gulp packages:${{needs.extract_info.outputs.release_type}}:build

      - name: Test ğŸ§ª
        run: npm run gulp packages:${{needs.extract_info.outputs.release_type}}:test

  publish-npm:
    name: Publish to NPM Registry ğŸ“¦
    needs: [draft-release, build, extract_info]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Setup Node.js ğŸ“¦
        uses: actions/setup-node@v3
        with:
          node-version: 16
          registry-url: https://registry.npmjs.org/

      - name: Install dependencies ğŸ”ƒ
        run: npm ci

      - name: Publish â˜ï¸
        run: npm run gulp packages:${{needs.extract_info.outputs.release_type}}:publish:npm:${{needs.extract_info.outputs.release_tag}}
        env:
          NODE_AUTH_TOKEN: ${{secrets.npm_token}}

  # publish-gpr:
  #   name: Publish to GitHub Package Registry ğŸ“¦
  #   needs: [draft-release, build, extract_info]
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     packages: write
  #   steps:
  #     - name: Checkout ğŸ›ï¸
  #       uses: actions/checkout@v3
  #     - name: Setup Node.js ğŸ“¦
  #       uses: actions/setup-node@v3
  #       with:
  #         node-version: 16
  #         registry-url: https://npm.pkg.github.com/
  #
  #     - name: Install dependencies ğŸ”ƒ
  #     run: npm ci
  #
  #     - name: Publish â˜ï¸
  #       run: npm run packages:${{needs.extract_info.outputs.release_type}}:publish:gpr
  #       env:
  #         NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

  draft-release:
    name: Draft Release for tag ğŸ“¦
    needs: [build, extract_info]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      discussions: write

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Setup Node.js ğŸ“¦
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install dependencies ğŸ”ƒ
        run: npm ci

      - name: Pack Release ğŸ“¦
        run: npm run gulp packages:${{needs.extract_info.outputs.release_type}}:pack
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      - name: Release â˜ï¸
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./packages/${{needs.extract_info.outputs.release_type}}/*.tgz
            ./packages/${{needs.extract_info.outputs.release_type}}/changelog.md
            ./packages/${{needs.extract_info.outputs.release_type}}/README.md
            ./packages/${{needs.extract_info.outputs.release_type}}/LICENSE
          tag_name: ${{github.ref}}
          body: |
            See changelog for details
          name: ${{github.ref_name}}
          draft: false
